# 分布式协议

## CAP

### CAP 理论

一个分布式系统最多只能同时满足**一致性(Consistency)**、**可用性(Availablity)**和**分区容错性(Partition tolerance)**这三项中的两项。

#### 一致性 Consistency

一致性指 `all nodes see the same data at the same time`，即所有节点在同一时间的数据完全一致。

一致性是因为多个数据拷贝下并发读写才有的问题，因此理解时一定要注意结合考虑多个数据拷贝下并发读写的场景。

**从客户端来看，一致性主要指的是多并发访问时更新过的数据如何获取的问题；从服务端来看，则是更新如何分布到整个系统，以保持数据一致。**

对于一致性，可以分为强一致性、弱一致性和最终一致性。

- 强一致性

  对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性；

- 弱一致性

  如果能容忍后续的部分或者全部访问不到，则是弱一致性；

- 最终一致性

  如果经过一段时间后要求能访问到更新后的数据，则是最终一致性。

#### 可用性 Availablity

可用性指 `Reads and writes always succeed`，即服务在正常响应时间内一直可用。

好的可用性主要是指系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。可用性通常情况下可用性和分布式数据冗余，负载均衡等有着很大的关联。

#### 分区容错 Partition Tolerance

分区容错性指 `the system continues to operate despite arbitrary message loss or failure of part of the system`，即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性或可用性的服务。



### CAP 不可能三角

CAP 不可能三角说的是对于一个分布式系统而言，一致性（Consistency）、可用性（Availability）、分区容错性（Partition Tolerance）3 个指标不可兼得，只能在 3 个指标中选择 2 个。

<img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbul0hycu2j30vq0pbn2j.jpg" style="zoom: 33%;" />

只要有网络交互就一定会有延迟和数据丢失，而这种状况我们必须接受，还必须保证系统不能挂掉。节点间的分区故障是必然发生的。也就是说，分区容错性（P）是前提，是必须要保证的。

现在就只剩下一致性（C）和可用性（A）可以选择了：要么选择一致性，保证数据绝对一致；要么选择可用性，保证服务可用。

- **CA 模型** CA 满足数据的一致性和高可用性，但没有可扩展性。如传统的单节点关系型数据库 ORACLE、MYSQL ，就是满足数据的一致性和高可用性；

- **CP 模型** 当选择了一致性（C）的时候，如果因为消息丢失、延迟过高发生了网络分区，那么这个时候，当集群节点接收到来自客户端的写请求时，因为无法保证所有节点都是最新信息，所以系统将返回写失败错误，也就是说集群拒绝新数据写入。典型的应用是 Zookeeper、Etcd 和 HBase；
- **AP 模型** 当选择了可用性（A）的时候，系统将始终处理客户端的查询，返回特定信息，如果发生了网络分区，一些节点将无法返回最新的特定信息，它们将返回自己当前的相对新的信息。典型的应用是 Cassandra 和 DynamoDB。



## ACID 理论

### Atomicity 原子性

整个事务中的所有操作，要么全部完成，要么全部不完成，不可能停滞在中间某个环节。事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。

### Consistency 一致性

一个事务可以封装状态改变（除非它是一个只读的）。事务必须始终保持系统处于一致的状态，不管在任何给定的时间并发事务有多少。

### Isolation 隔离性

多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其它事务运行效果。

### Durability 持久性

在事务完成以后，该事务对数据库所作的更改便持久的保存在数据库之中，并不会被回滚。



